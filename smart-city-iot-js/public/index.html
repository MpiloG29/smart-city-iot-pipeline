<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÌøôÔ∏è Johannesburg Smart City Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 2.5rem;
            color: #1E3A8A;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-left p {
            color: #666;
            font-size: 1.1rem;
        }

        .header-right {
            text-align: right;
        }

        .status {
            background: #10B981;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 10px;
        }

        .last-update {
            color: #666;
            font-size: 0.9rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .traffic { color: #3B82F6; }
        .speed { color: #10B981; }
        .incidents { color: #EF4444; }
        .aqi { color: #F59E0B; }
        .alerts { color: #8B5CF6; }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .main-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #E5E7EB;
        }

        .card-header h2 {
            color: #1E3A8A;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .refresh-btn {
            background: #3B82F6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        .refresh-btn:hover {
            background: #2563EB;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #F3F4F6;
            text-align: left;
            padding: 12px;
            font-weight: 600;
            color: #666;
            border-bottom: 2px solid #E5E7EB;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #E5E7EB;
        }

        .congestion-low { color: #10B981; font-weight: bold; }
        .congestion-moderate { color: #F59E0B; font-weight: bold; }
        .congestion-high { color: #EF4444; font-weight: bold; }
        .congestion-severe { color: #DC2626; font-weight: bold; }

        .alert-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .alert-item {
            background: #FEF3C7;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #F59E0B;
        }

        .alert-item.high {
            background: #FEE2E2;
            border-left-color: #DC2626;
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .alert-location {
            font-weight: bold;
            color: #1F2937;
        }

        .alert-time {
            color: #6B7280;
            font-size: 0.9rem;
        }

        .alert-message {
            color: #374151;
            line-height: 1.5;
        }

        .map-container {
            background: #E5E7EB;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .map-placeholder {
            font-size: 1.2rem;
            color: #6B7280;
            padding: 40px 0;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: white;
            font-size: 0.9rem;
            margin-top: 30px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .connection-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10B981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .incident-badge {
            background: #EF4444;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1>ÌøôÔ∏è Johannesburg Smart City Dashboard</h1>
                <p>Real-time IoT Monitoring System</p>
            </div>
            <div class="header-right">
                <div class="status">Ìø¢ System Online</div>
                <div class="last-update" id="last-update">Last update: Just now</div>
                <div class="connection-status">
                    <div class="connection-dot"></div>
                    <span id="connection-status">Connected to WebSocket</span>
                </div>
            </div>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Active Cameras</h3>
                <div class="stat-value traffic" id="camera-count">5</div>
                <p>Monitoring 5 locations across Johannesburg</p>
            </div>
            <div class="stat-card">
                <h3>Average Speed</h3>
                <div class="stat-value speed" id="avg-speed">42.5 km/h</div>
                <p>Across all monitored routes</p>
            </div>
            <div class="stat-card">
                <h3>Active Incidents</h3>
                <div class="stat-value incidents" id="incident-count">0</div>
                <p>Traffic incidents requiring attention</p>
            </div>
            <div class="stat-card">
                <h3>Air Quality (AQI)</h3>
                <div class="stat-value aqi" id="aqi-value">65</div>
                <p>Current average air quality index</p>
            </div>
            <div class="stat-card">
                <h3>Active Alerts</h3>
                <div class="stat-value alerts" id="alert-count">0</div>
                <p>System alerts and notifications</p>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="main-card">
                <div class="card-header">
                    <h2>Ì∫¶ Live Traffic Data</h2>
                    <button class="refresh-btn" onclick="fetchTrafficData()">Refresh</button>
                </div>
                <div class="table-container">
                    <table id="traffic-table">
                        <thead>
                            <tr>
                                <th>Location</th>
                                <th>Vehicles</th>
                                <th>Speed</th>
                                <th>Congestion</th>
                                <th>Status</th>
                                <th>Last Update</th>
                            </tr>
                        </thead>
                        <tbody id="traffic-body">
                            <!-- Traffic data will appear here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="map-container">
                    <div class="map-placeholder">
                        Ì∑∫Ô∏è Johannesburg Traffic Map
                        <div style="font-size: 1rem; margin-top: 10px; color: #4B5563;">
                            CBD ‚Ä¢ Sandton ‚Ä¢ Soweto ‚Ä¢ Rosebank ‚Ä¢ Germiston
                        </div>
                    </div>
                </div>
            </div>

            <div class="alert-card">
                <div class="card-header">
                    <h2>Ì∫® Active Alerts</h2>
                    <button class="refresh-btn" onclick="fetchAlerts()">Refresh</button>
                </div>
                <div id="alerts-container">
                    <!-- Alerts will appear here -->
                    <div class="alert-item">
                        <div class="alert-header">
                            <div class="alert-location">System</div>
                            <div class="alert-time">Just now</div>
                        </div>
                        <div class="alert-message">Dashboard initialized. Monitoring 5 locations.</div>
                    </div>
                </div>

                <div class="card-header" style="margin-top: 30px;">
                    <h2>Ìº´Ô∏è Air Quality</h2>
                </div>
                <table id="air-quality-table">
                    <thead>
                        <tr>
                            <th>Location</th>
                            <th>AQI</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="air-quality-body">
                        <!-- Air quality data will appear here -->
                    </tbody>
                </table>
            </div>
        </div>

        <footer>
            <p>ÌøôÔ∏è Johannesburg Smart City IoT Monitoring System | Real-time Dashboard</p>
            <p>Data updates every 5 seconds | Powered by Node.js & Socket.io</p>
        </footer>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Connect to WebSocket server
        const socket = io();
        
        // DOM elements
        const trafficBody = document.getElementById('traffic-body');
        const airQualityBody = document.getElementById('air-quality-body');
        const alertsContainer = document.getElementById('alerts-container');
        const cameraCount = document.getElementById('camera-count');
        const avgSpeed = document.getElementById('avg-speed');
        const incidentCount = document.getElementById('incident-count');
        const aqiValue = document.getElementById('aqi-value');
        const alertCount = document.getElementById('alert-count');
        const lastUpdate = document.getElementById('last-update');
        const connectionStatus = document.getElementById('connection-status');
        
        // Traffic data storage
        let currentTrafficData = [];
        let currentAirQualityData = [];
        let currentAlerts = [];
        
        // Update time display
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            lastUpdate.textContent = `Last update: ${timeStr}`;
        }
        
        // Initialize tables with sample data
        function initializeTables() {
            const locations = [
                { name: 'CBD', type: 'urban' },
                { name: 'Sandton', type: 'commercial' },
                { name: 'Soweto', type: 'residential' },
                { name: 'Rosebank', type: 'commercial' },
                { name: 'Germiston', type: 'industrial' }
            ];
            
            // Initialize traffic table
            locations.forEach(location => {
                const vehicles = Math.floor(Math.random() * 40) + 10;
                const speed = Math.floor(Math.random() * 50) + 20;
                const congestion = speed < 20 ? 'severe' : speed < 40 ? 'high' : speed < 60 ? 'moderate' : 'low';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${location.name}</td>
                    <td>${vehicles}</td>
                    <td>${speed} km/h</td>
                    <td class="congestion-${congestion}">${congestion.charAt(0).toUpperCase() + congestion.slice(1)}</td>
                    <td>${Math.random() > 0.95 ? '<span class="incident-badge">Incident</span>' : '‚úÖ Normal'}</td>
                    <td>Just now</td>
                `;
                trafficBody.appendChild(row);
            });
            
            // Initialize air quality table
            locations.forEach(location => {
                const aqi = Math.floor(Math.random() * 70) + 30;
                const category = aqi < 50 ? 'Good' : aqi < 100 ? 'Moderate' : 'Unhealthy';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${location.name}</td>
                    <td>${aqi}</td>
                    <td>${category}</td>
                `;
                airQualityBody.appendChild(row);
            });
            
            updateTime();
        }
        
        // Update traffic table with new data
        function updateTrafficTable(data) {
            // Find or create row for this location
            let row = Array.from(trafficBody.rows).find(r => r.cells[0].textContent === data.location.name);
            
            if (!row) {
                row = document.createElement('tr');
                trafficBody.appendChild(row);
            }
            
            const congestion = data.congestion;
            const congestionClass = `congestion-${congestion}`;
            const congestionText = congestion.charAt(0).toUpperCase() + congestion.slice(1);
            
            row.innerHTML = `
                <td>${data.location.name}</td>
                <td>${data.vehicles}</td>
                <td>${data.speed} km/h</td>
                <td class="${congestionClass}">${congestionText}</td>
                <td>${data.incident_detected ? '<span class="incident-badge">Incident</span>' : '‚úÖ Normal'}</td>
                <td>${new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
            `;
            
            // Update statistics
            updateStatistics();
        }
        
        // Update air quality table
        function updateAirQualityTable(data) {
            let row = Array.from(airQualityBody.rows).find(r => r.cells[0].textContent === data.location.name);
            
            if (!row) {
                row = document.createElement('tr');
                airQualityBody.appendChild(row);
            }
            
            row.innerHTML = `
                <td>${data.location.name}</td>
                <td>${data.aqi}</td>
                <td>${data.category}</td>
            `;
            
            // Update AQI value with average
            const allAqi = currentAirQualityData.map(d => d.aqi);
            const avgAqi = allAqi.length > 0 ? 
                Math.round(allAqi.reduce((a, b) => a + b, 0) / allAqi.length) : 65;
            aqiValue.textContent = avgAqi;
        }
        
        // Add alert to dashboard
        function addAlert(alert) {
            const alertItem = document.createElement('div');
            alertItem.className = `alert-item ${alert.severity === 'high' ? 'high' : ''}`;
            
            const time = new Date(alert.timestamp);
            const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            alertItem.innerHTML = `
                <div class="alert-header">
                    <div class="alert-location">${alert.location}</div>
                    <div class="alert-time">${timeStr}</div>
                </div>
                <div class="alert-message">${alert.message}</div>
            `;
            
            alertsContainer.insertBefore(alertItem, alertsContainer.firstChild);
            
            // Keep only last 10 alerts
            while (alertsContainer.children.length > 10) {
                alertsContainer.removeChild(alertsContainer.lastChild);
            }
            
            // Update alert count
            alertCount.textContent = currentAlerts.length;
        }
        
        // Update statistics
        function updateStatistics() {
            if (currentTrafficData.length > 0) {
                const incidents = currentTrafficData.filter(d => d.incident_detected).length;
                incidentCount.textContent = incidents;
                incidentCount.style.color = incidents > 0 ? '#EF4444' : '#10B981';
                
                const speeds = currentTrafficData.map(d => d.speed);
                const avg = speeds.length > 0 ? 
                    (speeds.reduce((a, b) => a + b, 0) / speeds.length).toFixed(1) : '42.5';
                avgSpeed.textContent = `${avg} km/h`;
            }
        }
        
        // Fetch initial data from API
        async function fetchInitialData() {
            try {
                const [trafficRes, airRes, alertsRes] = await Promise.all([
                    fetch('/api/traffic?limit=20'),
                    fetch('/api/air-quality?limit=10'),
                    fetch('/api/alerts?limit=10')
                ]);
                
                if (trafficRes.ok) {
                    const trafficData = await trafficRes.json();
                    currentTrafficData = trafficData.data || [];
                    
                    // Update traffic table
                    trafficBody.innerHTML = '';
                    currentTrafficData.forEach(updateTrafficTable);
                    
                    // Update statistics
                    if (trafficData.statistics) {
                        avgSpeed.textContent = `${trafficData.statistics.avg_speed?.toFixed(1) || '42.5'} km/h`;
                        incidentCount.textContent = trafficData.statistics.incidents || 0;
                    }
                }
                
                if (airRes.ok) {
                    const airData = await airRes.json();
                    currentAirQualityData = airData.data || [];
                    
                    // Update air quality table
                    airQualityBody.innerHTML = '';
                    currentAirQualityData.forEach(updateAirQualityTable);
                    
                    // Calculate average AQI
                    if (currentAirQualityData.length > 0) {
                        const avgAqi = Math.round(
                            currentAirQualityData.reduce((sum, d) => sum + d.aqi, 0) / currentAirQualityData.length
                        );
                        aqiValue.textContent = avgAqi;
                    }
                }
                
                if (alertsRes.ok) {
                    const alertsData = await alertsRes.json();
                    currentAlerts = alertsData.data || [];
                    
                    // Update alerts
                    alertsContainer.innerHTML = '';
                    currentAlerts.forEach(addAlert);
                    alertCount.textContent = currentAlerts.length;
                }
                
                updateTime();
            } catch (error) {
                console.error('Error fetching initial data:', error);
            }
        }
        
        // WebSocket event handlers
        socket.on('connect', () => {
            console.log('‚úÖ Connected to WebSocket server');
            connectionStatus.textContent = 'Connected to WebSocket';
            connectionStatus.style.color = '#10B981';
        });
        
        socket.on('disconnect', () => {
            console.log('‚ùå Disconnected from WebSocket');
            connectionStatus.textContent = 'Disconnected - Reconnecting...';
            connectionStatus.style.color = '#EF4444';
        });
        
        socket.on('welcome', (data) => {
            console.log('Server:', data.message);
            cameraCount.textContent = data.locations.length;
        });
        
        socket.on('initial_data', (data) => {
            console.log('Received initial data');
            currentTrafficData = data.traffic || [];
            currentAirQualityData = data.air_quality || [];
            currentAlerts = data.alerts || [];
            
            // Update tables
            trafficBody.innerHTML = '';
            currentTrafficData.forEach(updateTrafficTable);
            
            airQualityBody.innerHTML = '';
            currentAirQualityData.forEach(updateAirQualityTable);
            
            alertsContainer.innerHTML = '';
            currentAlerts.forEach(addAlert);
            
            updateStatistics();
            updateTime();
        });
        
        socket.on('traffic_update', (data) => {
            console.log('Ì≥° Traffic update:', data.location.name);
            
            // Add to current data
            currentTrafficData = [data, ...currentTrafficData.slice(0, 19)];
            
            // Update table
            updateTrafficTable(data);
            updateTime();
        });
        
        socket.on('air_quality_update', (data) => {
            console.log('Ìº´Ô∏è Air quality update:', data.location.name);
            
            // Add to current data
            currentAirQualityData = [data, ...currentAirQualityData.slice(0, 9)];
            
            // Update table
            updateAirQualityTable(data);
        });
        
        socket.on('alert', (alert) => {
            console.log('Ì∫® New alert:', alert.message);
            
            // Add to current alerts
            currentAlerts = [alert, ...currentAlerts.slice(0, 9)];
            
            // Update alerts display
            addAlert(alert);
            
            // Show notification
            if (Notification.permission === 'granted') {
                new Notification('Smart City Alert', {
                    body: `${alert.location}: ${alert.message}`,
                    icon: 'https://cdn-icons-png.flaticon.com/512/984/984172.png'
                });
            }
        });
        
        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
        
        // Manual refresh functions
        window.fetchTrafficData = async () => {
            try {
                const response = await fetch('/api/traffic?limit=20');
                const data = await response.json();
                if (data.success) {
                    currentTrafficData = data.data;
                    trafficBody.innerHTML = '';
                    currentTrafficData.forEach(updateTrafficTable);
                    updateStatistics();
                    updateTime();
                }
            } catch (error) {
                console.error('Error fetching traffic data:', error);
            }
        };
        
        window.fetchAlerts = async () => {
            try {
                const response = await fetch('/api/alerts?limit=10');
                const data = await response.json();
                if (data.success) {
                    currentAlerts = data.data;
                    alertsContainer.innerHTML = '';
                    currentAlerts.forEach(addAlert);
                    alertCount.textContent = currentAlerts.length;
                }
            } catch (error) {
                console.error('Error fetching alerts:', error);
            }
        };
        
        // Initialize
        initializeTables();
        fetchInitialData();
        
        // Update time every second
        setInterval(updateTime, 1000);
        
        // Auto-refresh data every 30 seconds
        setInterval(fetchInitialData, 30000);
    </script>
</body>
</html>
